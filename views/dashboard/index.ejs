<%- include('../partials/header') %>

<section>
  <h1>Customer Dashboard</h1>
  <p>Manage automation jobs, token balance, and payment approvals.</p>
</section>

<section class="grid stats-grid">
  <article class="card stat-card">
    <h3>Token Balance</h3>
    <p><%= tokenBalance %></p>
  </article>
  <article class="card stat-card">
    <h3>Total Jobs</h3>
    <p><%= stats.total_jobs || 0 %></p>
  </article>
  <article class="card stat-card">
    <h3>Active Jobs</h3>
    <p><%= stats.active_jobs || 0 %></p>
  </article>
  <article class="card stat-card">
    <h3>Pending Payments</h3>
    <p><%= paymentSummary?.pending_count || 0 %></p>
  </article>
</section>

<section class="grid two-col">
  <article class="card">
    <div class="section-head">
      <h2>Upcoming Runs</h2>
      <a href="/dashboard/jobs" class="btn btn-ghost">Manage Jobs</a>
    </div>
    <table>
      <thead>
        <tr>
          <th>Job</th>
          <th>Page</th>
          <th>Next Index</th>
          <th>Next Run</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% if (!upcomingJobs.length) { %>
          <tr><td colspan="5">No jobs yet.</td></tr>
        <% } %>
        <% upcomingJobs.forEach((job) => { %>
          <tr>
            <td><%= job.name %></td>
            <td><%= job.facebook_page_name %></td>
            <td><%= job.next_media_index %></td>
            <td><%= job.next_run_at || 'Pending' %></td>
            <td><span class="pill"><%= job.status %></span></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </article>

  <article class="card">
    <div class="section-head">
      <h2>Recent Payment Requests</h2>
      <a href="/dashboard/payments" class="btn btn-ghost">Open Wallet</a>
    </div>
    <table>
      <thead>
        <tr>
          <th>Amount</th>
          <th>Ref</th>
          <th>Status</th>
          <th>Tokens</th>
        </tr>
      </thead>
      <tbody>
        <% if (!recentPaymentRequests.length) { %>
          <tr><td colspan="4">No payment requests yet.</td></tr>
        <% } %>
        <% recentPaymentRequests.forEach((item) => { %>
          <tr>
            <td>PKR <%= Number(item.amount_pkr).toFixed(0) %></td>
            <td><%= item.transaction_ref %></td>
            <td><span class="pill"><%= item.status %></span></td>
            <td><%= item.tokens_to_credit || '-' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </article>
</section>

<section>
  <article class="card">
    <h2>Recent Automation Logs</h2>
    <ul class="log-list">
      <% if (!recentLogs.length) { %>
        <li>No logs yet.</li>
      <% } %>
      <% recentLogs.forEach((log) => { %>
        <li>
          <strong>[<%= log.level.toUpperCase() %>]</strong>
          <span><%= log.job_name %> - <%= log.message %></span>
          <small><%= log.created_at %></small>
        </li>
      <% }) %>
    </ul>
  </article>
</section>

<%- include('../partials/footer') %>
